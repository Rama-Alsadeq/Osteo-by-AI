<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Osteo by AI – AI Diagnosis for Osteoarthritis & Osteoporosis</title>

    <meta name="description" content="Upload X-rays and clinical data to get AI-assisted diagnosis for Osteoarthritis and Osteoporosis with Osteo by AI.">
    <meta name="keywords" content="AI Diagnosis, Osteoarthritis, Osteoporosis, Knee X-rays, Clinical Data, Osteo by AI, الذكاء الاصطناعي, تشخيص هشاشة العظام, تشخيص الفصال العظمي">
    <meta name="author" content="Rama Alsadeq, Shaima Alharahsheh, Oula Hanandeh">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="min-h-screen flex flex-col">

  <header class="gradient-bg text-white shadow-md">
    <div class="container mx-auto px-6 py-6">
      <div class="flex items-start justify-start space-x-4 mb-4">
        <div class="icon-circle">
          <img src="{{ url_for('static', filename='pic.JPG') }}" alt="OsteoAI Logo" class="w-12 h-12 rounded-full" />
        </div>
        <div class="text-left">
          <h1 class="text-4xl font-bold">Osteo by AI</h1>
          <p class="text-sm opacity-90">End-to-end AI framework for osteoarthritis and osteoporosis diagnosis</p>
        </div>
      </div>
    <nav class="flex justify-start space-x-6 text-left mt-6">
       <a href="{{ url_for('home') }}">Home</a>
<a href="{{ url_for('ai_models') }}">AI Diagnosis</a>
<a href="{{ url_for('about') }}">About</a>

      </nav>
    </div>
  </header>



<div id="main-content" class="flex-grow flex flex-col">
  <main class="flex-grow">




       <section id="aiModels" class="py-16 px-6 bg-[#f7fafc] text-gray-900">
  <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- Osteoarthritis Diagnosis -->
    <div class="cursor-pointer rounded-2xl shadow-lg p-8 bg-gradient-to-r from-[#00b4db] to-[#0083b0] text-white text-center transition transform hover:scale-105 hover:shadow-2xl"
         onclick="showUploadFrame()">
      <h3 class="text-2xl font-bold mb-2">Osteoarthritis Diagnosis</h3>
      <p class="text-sm opacity-90">Detect osteoarthritis severity using AI-powered models.</p>
    </div>

    <!-- Osteoporosis Diagnosis -->
    <div class="cursor-pointer rounded-2xl shadow-lg p-8 bg-gradient-to-r from-[#00b4db] to-[#0083b0] text-white text-center transition transform hover:scale-105 hover:shadow-2xl"
         onclick="showSection('osteoporosisFrames')">
      <h3 class="text-2xl font-bold mb-2">Osteoporosis Diagnosis</h3>
      <p class="text-sm opacity-90">Predict osteoporosis risk with multi-source AI ensemble models.</p>
    </div>

  </div>
</section>



        <!-- Upload Frame (OA) -->
     <section id="uploadSection" style=" display: none; max-width: 1200px; margin: 40px auto; padding: 0 20px;" >

  <div id="notesContainer"
     style="
       background: #fff9db;
       border-left: 5px solid #f2d67a;
       max-width: 1150px;
       padding:20px;
       border-radius: 8px;
       color: #000000;
       font-size: 1rem;
       margin-bottom: 20px;

     ">
  <p><strong><span >Note 1:</span></strong> Please provide authentic and verifiable data only.</p>
  <p><strong><span >Note 2:</span></strong> This tool is not a substitute for expert medical advice. Always consult a qualified healthcare professional for diagnosis and treatment.</p>
</div>


  <div class="special-frame" id="uploadFrame"
       style="
         background: white;
         padding: 20px;
         border-radius: 8px;
         box-shadow: 0 4px 10px rgba(0,0,0,0.15);
         display: flex;
         flex-direction: column;
         gap: 15px;
         max-width: 1200px;
       ">
    <label>Upload knee images:</label>
  <div class="mb-4">
  <label for="oaimageOne">Image One: </label>
  <input type="file" id="oaimageOne" accept=".dcm,.png,.jpg,.jpeg,.bmp" onchange="showPreview(this)"/>
</div>
<div class="mb-4">
  <label for="oaimageTwo">Image Two: </label>
  <input type="file" id="oaimageTwo" accept=".dcm,.png,.jpg,.jpeg,.bmp" onchange="showPreview(this)"/>
</div>
<div id="imagesPreview" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>

      <div id="notes" style="
    background: white;           /* خلفية بيضاء */
    border-left: 5px solid #0083b0; /* خط أيسر سميك باللون الأزرق */
    padding: 15px;
    border-radius: 5px;
    color: #000000;
    font-size: 1rem;
    max-width: 1200px;
">
          <p>* You can upload one image for both knees or each knee separately.</p>
          <p>* Ensure that the images are vertical and not rotated.</p>
          <p>* Supported image formats: jpg, jpeg, png, and bmp.</p>
</div>
    <div class="send-button-container" style="width: 100%; display: flex; justify-content: center;">
      <button id="sendBtn" onclick="submitXray()" class="btn-send">Send</button>
    </div>
      <div id="loadingSpinner" style="display:none; text-align:center; margin-top:20px;">
    <div class="spinner"></div>
    <p>Processing... Please wait</p>
</div>

  </div>
         <!-- رسالة الخطأ أو عدم اكتشاف المفصل -->
<div id="messageContainer" style="color:red; font-size:1rem; margin-top:10px; max-width: 1200px;"></div>

        <div id="processedResultsSection" style="display:none;">
    <h3>Preprocessing Steps:</h3>
    <div id="processedImagesContainer"></div>
</div>


</section>



        <!-- Osteoporosis Frames Section -->
<section id="osteoporosisFrames" style="display: none; max-width: 1200px; margin: 40px auto; padding: 0 20px;">

    <div class="notes mb-6 p-4" style="background-color: #fff9db; border-left: 4px solid #f2d67a; color: #000;">
        <p><strong><span >Note 1:</span></strong> Kindly ensure that at least one frame is completed.</p>
        <p><strong><span >Note 2:</span></strong> Please provide authentic and verifiable data only.</p>
        <p><strong><span >Note 3:</span></strong> This tool is not a substitute for expert medical advice. Always consult a qualified healthcare professional for diagnosis and treatment.</p>
    </div>

    <!-- Frame 1: BMD Test -->
<form id="bmdForm" onsubmit="validateFirstFrame(event)">
    <div class="frame flex-col p-4 mb-6 special-frame">
        <h3 class="text-xl font-semibold mb-4">Frame 1: BMD Test</h3>

        <div class="mb-2">
            <label>Age:</label>
            <input type="number" id="bmdAgePorosis" class="border p-2 w-full rounded" min="1" max="150" />
        </div>

        <div class="mb-2">
            <label>Gender:</label>
            <select id="bmdGender" class="border p-2 w-full rounded">
                <option value="">Select</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
        </div>

        <div class="mb-2">
            <label>Test Type:</label>
            <select id="testType" class="border p-2 w-full rounded">
                <option value="">Select</option>
                <option value="Z-Score">Z-Score</option>
                <option value="T-Score">T-Score</option>
            </select>
        </div>

        <div class="mb-4">
            <label>Test Result:</label>
            <input type="number" id="testResult" class="border p-2 w-full rounded" step="0.01" min="-5" max="3" />
        </div>

        <button type="submit" class="btn-submit">Submit Frame 1</button>

    </div>
</form>

    <!-- Frame 2: X-rays of the knees (visible directly) -->
    <div class="frame flex-col p-4 mb-6 special-frame">
        <h3 class="text-xl font-semibold mb-4">Frame 2: X-rays of the knees</h3>

        <div>
            <label for="imageOnePorosis">Image One:</label>
            <input type="file" id="imageOnePorosis" accept=".dcm,.png,.jpg,.jpeg,.bmp,.DCM,.PNG,.JPG,.JPEG,.BMP" />
        </div>

        <div>
            <label for="imageTwoPorosis">Image Two:</label>
            <input type="file" id="imageTwoPorosis" accept=".dcm,.png,.jpg,.jpeg,.bmp,.DCM,.PNG,.JPG,.JPEG,.BMP" />
        </div>

     <div id="notesPorosis" style="
    background: white;           /* خلفية بيضاء */
    border-left: 5px solid #0083b0; /* خط أيسر سميك باللون الأزرق */
    padding: 15px;
    border-radius: 5px;
    color: #000000;
    font-size: 1rem;
">
    <p>* You can upload one image for both knees or each knee separately.</p>
         <p>* Ensure the images are vertical and not rotated.</p>
    <p>* Supported image formats: jpg, jpeg, png, and bmp.</p>
</div>
        <div id="imagesPreviewPorosis" class="flex gap-3 flex-wrap mt-4"></div>

        <button id="submitFrame2" onclick="submitFrame2()" class="btn-submit mt-4">
    Submit Frame 2
</button>
    </div>

    <!-- Frame 3: Risk Factors -->
<div class="frame flex-col p-4 space-y-3 mb-6 special-frame">
    <h3 class="text-xl font-semibold mb-2">Frame 3: Risk Factors</h3>

    <div>
        <label>Age:</label>
        <input type="number" id="riskAge" class="border p-2 w-full rounded" min="1" max="120" />
    </div>

    <div>
        <label>Gender:</label>
        <select id="riskGender" class="border p-2 w-full rounded">
            <option>Male</option>
            <option>Female</option>
        </select>
    </div>

    <div>
        <label>Hormonal Changes:</label>
        <select id="riskHormonal" class="border p-2 w-full rounded">
            <option>Normal</option>
            <option>Postmenopausal</option>
        </select>
    </div>

    <div>
        <label>Genetic Tendency:</label>
        <select id="riskGenetic" class="border p-2 w-full rounded">
            <option>Yes</option>
            <option>No</option>
        </select>
    </div>

    <div>
        <label>Race/Ethnicity:</label>
        <select id="riskEthnicity" class="border p-2 w-full rounded">
            <option>Asian</option>
            <option>Caucasian</option>
            <option>African American</option>
        </select>
    </div>

    <div>
        <label>Body Weight:</label>
        <select id="riskWeight" class="border p-2 w-full rounded">
            <option>Underweight</option>
            <option>Normal</option>
        </select>
    </div>

    <div>
        <label>Calcium Intake:</label>
        <select id="riskCalcium" class="border p-2 w-full rounded">
            <option>Low</option>
            <option>Adequate</option>
        </select>
    </div>

    <div>
        <label>Vitamin D Intake:</label>
        <select id="riskVitaminD" class="border p-2 w-full rounded">
            <option>Sufficient</option>
            <option>Insufficient</option>
        </select>
    </div>

    <div>
        <label>Physical Activity:</label>
        <select id="riskActivity" class="border p-2 w-full rounded">
            <option>Active</option>
            <option>Sedentary</option>
        </select>
    </div>

    <div>
        <label>Smoking:</label>
        <select id="riskSmoking" class="border p-2 w-full rounded">
            <option>Yes</option>
            <option>No</option>
        </select>
    </div>

    <div>
        <label>Alcohol Consumption:</label>
        <select id="riskAlcohol" class="border p-2 w-full rounded">
            <option>None</option>
            <option>Moderate</option>
        </select>
    </div>

    <div>
        <label>Medical Conditions:</label>
        <select id="riskMedical" class="border p-2 w-full rounded">
            <option>None</option>
            <option>Hyperthyroidism</option>
            <option>Rheumatoid Arthritis</option>
        </select>
    </div>

    <div>
        <label>Medications:</label>
        <select id="riskMeds" class="border p-2 w-full rounded">
            <option>Corticosteroids</option>
            <option>None</option>
        </select>
    </div>

    <div>
        <label>Prior Fractures:</label>
        <select id="riskFractures" class="border p-2 w-full rounded">
            <option>Yes</option>
            <option>No</option>
        </select>
    </div>

    <button onclick="submitRiskFactors()" class="btn-submit">Submit Frame 3</button>

</div>


    <!-- Send All Button -->
    <div class="flex justify-center">
        <button id="sendBtnPorosis" onclick="sendAll()" class="bg-green-600 text-white px-6 py-2 rounded font-bold">Send</button>
    </div>
    <!-- Spinner / Loading animation -->
<div id="loadingSpinnerPorosis" style="display:none; text-align:center; margin-top:20px;">
  <div class="spinner"></div>
  <p>Processing... Please wait</p>
</div>



    <div id="allFrameResult">
         <div id="frame1Result" style="margin-top:10px; font-weight:bold;"></div>
    </div>



</section>
 </main>
</div>




 <footer class="bg-gray-600 text-white" style="min-height: 100px; width: 100%;">
    <div class="container mx-auto px-6 py-6 h-full flex flex-col justify-between">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
        <div>
          <h3 class="text-xl font-bold mb-2">Site</h3>
          <ul class="space-y-1 text-sm text-gray-300">
           <li><a href="{{ url_for('home') }}" class="hover:text-white transition duration-300">Home</a></li>
           <li><a href="{{ url_for('ai_models') }}" class="hover:text-white transition duration-300">AI Diagnosis</a></li>
           <li><a href="{{ url_for('about') }}" class="hover:text-white transition duration-300">About</a></li>

          </ul>
        </div>
        <div>
          <h3 class="text-xl font-bold mb-2">Version Info</h3>
          <ul class="space-y-1 text-sm text-gray-300">
            <li>Version: 1.0.0</li>
            <li>Updated: Aug 2025</li>
            <li><a href="https://github.com/Rama-Alsadeq/Osteo-by-AI" class="hover:text-white transition duration-300">GitHub</a></li>
          </ul>
        </div>
        <div>
          <h3 class="text-xl font-bold mb-2">Quick Contact Links</h3>
          <ul class="space-y-1 text-sm text-gray-300">
            <li><a href="https://www.linkedin.com/in/rama-alsadeq-879bb9290"
                   class="hover:text-white transition duration-300">LinkedIn: Member 1</a></li>

            <li><a href="https://www.linkedin.com/in/shaima-feras-758bab311" class="hover:text-white transition duration-300">LinkedIn: Member 2</a></li>
            <li><a href="https://www.linkedin.com/in/ola-hanandeh-2b275a299" class="hover:text-white transition duration-300">LinkedIn: Member 3</a></li>
            <li><a href="{{ url_for('about') }}" class="hover:text-white transition duration-300">More</a></li>
          </ul>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-6 pt-4 text-center text-sm text-gray-400">
        <p>&copy; 2025 Osteo by AI. Licensed under the MIT License.</p>
      </div>
    </div>
  </footer>



<script >

const allowedExtensions = ["dcm", "png", "jpg", "jpeg", "bmp"];
let frame1Data = null;
let frame2Data = null;

// دالة لاستخراج امتداد الملف من اسم الملف
function getExtension(filename) {
    return filename.split('.').pop().toLowerCase();
}

// التحقق إذا كان الملف يمتلك امتداد مدعوم
function isValidImage(file) {
    if (!file) return false;
    const ext = getExtension(file.name);
    return allowedExtensions.includes(ext);
}

// تعريف الأقسام الصالحة
const validSections = [ 'aiModels', 'uploadSection', 'osteoporosisFrames'];

function showSection(sectionId) {
    validSections.forEach(id => {
        document.getElementById(id).style.display = 'none';
    });
    document.getElementById(sectionId).style.display = 'block';
}

// عرض القسم حسب الهاَش عند تحميل الصفحة
document.addEventListener("DOMContentLoaded", () => {
    const hash = window.location.hash.substring(1);
    if (hash && validSections.includes(hash)) {
        showSection(hash);
    } else {
        showSection('aiModels'); // افتراضي
    }
});

// تغيير الأقسام عند تغيير الهَاش
window.addEventListener('hashchange', () => {
    const newHash = window.location.hash.substring(1);
    if (validSections.includes(newHash)) {
        showSection(newHash);
    }
});

// تحضير شاشة رفع الصور
function showUploadFrame() {
    showSection('uploadSection');
    document.getElementById('uploadFrame').scrollIntoView({ behavior: "smooth" });
    document.getElementById('oaimageOne').value = '';
    document.getElementById('oaimageTwo').value = '';
    document.getElementById('processedImagesContainer').innerHTML = '';
    document.getElementById('notes').style.display = 'block';
    document.getElementById('sendBtn').style.display = 'inline-block';
}

// عرض معاينة الصور
function displayPreview(fileInput) {
    let previewContainer = fileInput.id.includes('Porosis') ?
        document.getElementById('imagesPreviewPorosis') :
        document.getElementById('imagesPreview');

    // تنظيف الصورة القديمة للزر نفسه
    const oldImg = previewContainer.querySelector(`img[data-id="${fileInput.id}"]`);
    if (oldImg) previewContainer.removeChild(oldImg);

    if (fileInput.files[0]) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const imgEl = document.createElement('img');
            imgEl.src = e.target.result;
            imgEl.alt = file.name;
            imgEl.style.width = '150px';
            imgEl.style.height = '150px';
            imgEl.style.objectFit = 'contain';
            imgEl.setAttribute('data-id', fileInput.id);
            previewContainer.appendChild(imgEl);
        };
        reader.readAsDataURL(file);
    }
}

// أحداث لكل زر رفع
document.getElementById('oaimageOne').addEventListener('change', function() { displayPreview(this); });
document.getElementById('oaimageTwo').addEventListener('change', function() { displayPreview(this); });
document.getElementById('imageOnePorosis').addEventListener('change', function() { displayPreview(this); });
document.getElementById('imageTwoPorosis').addEventListener('change', function() { displayPreview(this); });



function showPreview(inputElement) {
    const file = inputElement.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewImage = document.getElementById("previewImage");
            if(previewImage){
                previewImage.src = e.target.result;
            }
        };
        reader.readAsDataURL(file);
    }
}



// رفع صور OA
async function submitXray() {
    const spinner = document.getElementById('loadingSpinner');
    spinner.style.display = 'block';

    const img1 = document.getElementById('oaimageOne').files[0];
    const img2 = document.getElementById('oaimageTwo').files[0];

    const messageContainer = document.getElementById('messageContainer');
    const processedSection = document.getElementById('processedResultsSection');
    const previewContainer = document.getElementById('imagesPreview');

    messageContainer.innerHTML = '';
    processedSection.innerHTML = '';
    processedSection.style.display = 'none';
    previewContainer.innerHTML = '';

    // --- Preview uploaded images ---
    [img1, img2].forEach(file => {
        if(file){
            const reader = new FileReader();
            reader.onload = function(e){
                const imgEl = document.createElement('img');
                imgEl.src = e.target.result;
                imgEl.className = "rounded-xl shadow-md border p-1 m-2";
                imgEl.style.width='150px';
                imgEl.style.height='150px';
                imgEl.style.objectFit='cover';
                previewContainer.appendChild(imgEl);
            };
            reader.readAsDataURL(file);
        }
    });

    const formData = new FormData();
    if(img1) formData.append('xray', img1);
    if(img2) formData.append('xray', img2);

    if(!img1 && !img2){
        messageContainer.innerHTML = `<div class="p-3 bg-yellow-100 text-yellow-800 rounded-md shadow"> Please upload at least one image.</div>`;
        spinner.style.display='none';
        return;
    }

    try {
        const response = await fetch('/process_oa', { method:'POST', body: formData });
        const data = await response.json();

        if(!data.analysis || data.analysis.length === 0){
            processedSection.innerHTML = `<div class="p-3 bg-red-100 text-red-800 rounded-md shadow"> No Knee Joint Detected.</div>`;
            processedSection.style.display='block';
            return;
        }

        data.analysis.forEach((fileData, fileIdx) => {
            // === ملف كامل ===
            const fileCard = document.createElement('div');
            fileCard.className = "bg-white rounded-2xl shadow-lg p-6 mb-8 border";

            const fileTitle = document.createElement('h2');
            fileTitle.innerText = `Image: ${fileData.file_name}`;
            fileTitle.className = "text-xl font-bold text-[#0083b0] mb-4";
            fileCard.appendChild(fileTitle);

            fileData.image_sections.forEach(section => {
                // --- General preprocessing ---
                if(section.section_type === 'general'){
                    const generalTitle = document.createElement('h3');
                    generalTitle.innerText = 'General Preprocessing';
                    generalTitle.className = "text-lg font-semibold text-gray-700 mt-2 mb-4";
                    fileCard.appendChild(generalTitle);

                    const stepsWrapper = document.createElement('div');
                    stepsWrapper.className = "flex flex-wrap gap-4";

                    section.steps.forEach(step => {
                        const stepDiv = document.createElement('div');
                        stepDiv.className = "text-center bg-gray-50 rounded-lg shadow p-3";

                        const img = document.createElement('img');
                        img.src = step.image;
                        img.alt = step.title;
                        img.className = "rounded-lg mb-2 shadow-sm";
                        img.style.width='130px';
                        img.style.height='130px';
                        img.style.objectFit='contain';

                        const caption = document.createElement('div');
                        caption.innerText = step.title;
                        caption.className = "text-sm text-gray-600";

                        stepDiv.appendChild(img);
                        stepDiv.appendChild(caption);
                        stepsWrapper.appendChild(stepDiv);
                    });

                    fileCard.appendChild(stepsWrapper);
                }

                // --- Knee section with results ---
                if(section.section_type === 'knee'){
                    const kneeTitle = document.createElement('h3');
                    kneeTitle.innerHTML = `<span class="font-bold text-lg text-gray-800">${section.knee_position}</span> - OA Diagnosis`;
                    kneeTitle.className = "mt-6 mb-3";
                    fileCard.appendChild(kneeTitle);

                    const wrapperDiv = document.createElement('div');
                    wrapperDiv.className = "flex flex-wrap gap-4";

                    // Preprocessing images
                    section.preprocessing.forEach(step => {
                        const stepDiv = document.createElement('div');
                        stepDiv.className = "text-center bg-gray-50 rounded-lg shadow p-3";

                        const img = document.createElement('img');
                        img.src = step.image;
                        img.alt = step.title;
                        img.className = "rounded-lg mb-2 shadow-sm";
                        img.style.width='130px';
                        img.style.height='130px';
                        img.style.objectFit='contain';

                        const caption = document.createElement('div');
                        caption.innerText = step.title;
                        caption.className = "text-sm text-gray-600";

                        stepDiv.appendChild(img);
                        stepDiv.appendChild(caption);
                        wrapperDiv.appendChild(stepDiv);
                    });

                    // Grad-CAM
                    if(section.explain && section.explain.startsWith('data:image')){
                        const gradDiv = document.createElement('div');
                        gradDiv.className = "text-center bg-gray-50 rounded-lg shadow p-3";

                        const gradImg = document.createElement('img');
                        gradImg.src = section.explain;
                        gradImg.alt = "Diagnostic Highlights";
                        gradImg.className = "rounded-lg mb-2 shadow-sm";
                        gradImg.style.width='130px';
                        gradImg.style.height='130px';
                        gradImg.style.objectFit='contain';

                        const gradCaption = document.createElement('div');
                        gradCaption.innerText = "Diagnostic Highlights";
                        gradCaption.className = "text-sm text-gray-600";

                        gradDiv.appendChild(gradImg);
                        gradDiv.appendChild(gradCaption);
                        wrapperDiv.appendChild(gradDiv);
                    }

                    fileCard.appendChild(wrapperDiv);


                   // --- Results ---
const resultsBox = document.createElement('div');
resultsBox.className = "mt-4 p-3 bg-blue-50 rounded-lg border shadow-sm";

section.result.forEach(pred => {
    const p = document.createElement('p');
    const maxConfidence = Math.max(...section.result.map(r=>parseFloat(r.confidence)));

    if(parseFloat(pred.confidence) === maxConfidence){

        p.innerHTML = `✅ <b>${pred.label}: ${pred.confidence}</b>`;
        p.className = "text-lg mb-1 text-blue-700 font-bold";
    } else {

        p.innerHTML = `${pred.label}: ${pred.confidence}`;
        p.className = "text-sm text-gray-700";
    }

    resultsBox.appendChild(p);
});

fileCard.appendChild(resultsBox);

                }
            });

            processedSection.appendChild(fileCard);

            // --- Separator بين الصور ---
            if(fileIdx !== data.analysis.length-1){
                const separator = document.createElement('div');
                separator.className = "border-t-4 border-dashed border-[#0083b0] my-8";
                processedSection.appendChild(separator);
            }
        });

        processedSection.style.display='block';
        processedSection.scrollIntoView({ behavior:'smooth' });

    } catch(err){
        console.error('Error uploading image:', err);
        processedSection.innerHTML = `<div class="p-3 bg-red-100 text-red-800 rounded-md shadow"> Failed to send images to the server.</div>`;
        processedSection.style.display='block';
    } finally {
        spinner.style.display='none';
    }
}



// Frame 1
function validateFirstFrame(event) {
    event.preventDefault();
    const age = parseInt(document.getElementById('bmdAgePorosis').value);
    const gender = document.getElementById('bmdGender').value;
    const scoreType = document.getElementById('testType').value;
    const score = parseFloat(document.getElementById('testResult').value);

    if (!age || age < 1 || age > 150) { alert("Enter a valid age (1-150)."); return; }
    if (!gender) { alert("Select gender."); return; }
    if (!scoreType) { alert("Select test type."); return; }
    if (isNaN(score) || score < -5 || score > 3) { alert("Enter valid BMD score."); return; }

    window.frame1Data = { age, gender, score_type: scoreType, score }; // مهم جدًا
    alert("Frame 1 saved locally. Press 'Send' to get diagnosis.");
}

// Frame 2
function submitFrame2() {
    const img1 = document.getElementById('imageOnePorosis').files[0];
    const img2 = document.getElementById('imageTwoPorosis').files[0];

    if (!img1 && !img2) { alert("Upload at least one image."); return; }

    window.frame2Data = [];
    if (img1) window.frame2Data.push(img1);
    if (img2) window.frame2Data.push(img2);

    alert("Frame 2 images saved. Press 'Send'.");
}

// Frame 3

function submitRiskFactors() {
    const ageInput = document.getElementById("riskAge").value.trim();

    if (!ageInput) {
        alert(" Please enter Age");
        return;
    }

    // بناء object بالقيم المطابقة لما يتوقعه السيرفر
    let values = {
        age: parseInt(ageInput, 10),
        gender: document.getElementById("riskGender").value,
        hormonal: document.getElementById("riskHormonal").value,
        genetic: document.getElementById("riskGenetic").value,
        race: document.getElementById("riskEthnicity").value,    // تعديل الاسم ليطابق Flask
        weight: document.getElementById("riskWeight").value,
        calcium: document.getElementById("riskCalcium").value,
        vitamin: document.getElementById("riskVitaminD").value,  // تعديل الاسم ليطابق Flask
        activity: document.getElementById("riskActivity").value,
        smoking: document.getElementById("riskSmoking").value,
        alcohol: document.getElementById("riskAlcohol").value,
        conditions: document.getElementById("riskMedical").value,
        medications: document.getElementById("riskMeds").value,
        fractures: document.getElementById("riskFractures").value
    };

    // التحقق من أن كل الحقول غير فارغة
    const allFilled = Object.values(values).every(v => v !== null && v !== undefined && v !== "");
    if (!allFilled) {
        alert(" Please fill in all fields in Frame 3");
        return;
    }

    // حفظ البيانات عالمياً لتكون متاحة عند الضغط على Send
    window.frame3Data = values;
    alert(" Frame 3 data saved. Now click 'Send' to process all frames.");
}



// --- Send All Frames ---
async function sendAll() {
    document.getElementById("osteoporosisFrames").style.display = "block";
    const messageContainer = document.getElementById("frame1Result");
    messageContainer.innerHTML = "";
    const spinner = document.getElementById('loadingSpinnerPorosis');
    spinner.style.display = 'block';

    function mapLabel(label) {
        if (label === "Healthy" || label === "Healthy Knee" || label === "Normal") return "Normal";
        if (label === "Osteopenia") return "Osteopenia";
        if (label === "Osteoporosis") return "Osteoporosis";
        return "Normal";
    }

    try {
        let frame1Label = null;
        let frame2Labels = [];
        let frame3Label = null;

        // Helper to create card container
        function createCard(title, color) {
            const card = document.createElement('div');
            card.className = "bg-white rounded-2xl shadow-lg p-6 mb-6 border";
            const header = document.createElement('h2');
            header.className = `text-2xl font-bold mb-4 ${color}`; // تم تعديل الحجم إلى text-2xl
            header.innerText = title;
            card.appendChild(header);
            return card;
        }

        // --- Frame 1 ---
        if (window.frame1Data) {
            try {
                const res1 = await fetch('/process_all_frames', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ frame1: window.frame1Data })
                });
                if (res1.ok) {
                    const data1 = await res1.json();
                    if (data1.frame1) {
                        const resultText = mapLabel(data1.frame1.result || "No result");
                        const card = createCard("Frame 1: BMD Test Result", "text-[#0083b0]");
                        const p = document.createElement('p');
                        p.className = "text-gray-700 text-lg";
                        p.innerHTML = `<b>Diagnosis:</b> ${resultText}`;
                        card.appendChild(p);
                        messageContainer.appendChild(card);
                        frame1Label = resultText;
                    }
                }
            } catch(err) {
                console.warn("Frame 1 skipped due to error:", err);
            }
        }


// --- Frame 2 ---
if (window.frame2Data && window.frame2Data.length) {
    try {
        const formData = new FormData();
        window.frame2Data.forEach(file => formData.append("xray", file));
        const res2 = await fetch('/process_porosis', { method:'POST', body: formData });

        if(res2.ok){
            const data2 = await res2.json();
            if(!data2.analysis || data2.analysis.length === 0){
                const warnDiv = document.createElement('div');
                warnDiv.className = "p-3 bg-red-100 text-red-800 rounded-md shadow";
                warnDiv.innerText = "❌ No Knee Joint Detected.";
                messageContainer.appendChild(warnDiv);
                return;
            }

            // --- Card رئيسي للفريم 2 ---
            const frame2Card = document.createElement('div');
            frame2Card.className = "bg-white rounded-2xl shadow-lg p-6 mb-8 border";

            // --- العنوان الرئيسي ---
            const frame2Title = document.createElement('h2');
            frame2Title.innerText = "Frame 2: X-rays of the knees Results";
            frame2Title.className = "text-2xl font-bold text-[#0083b0] mb-6";
            frame2Card.appendChild(frame2Title);

            data2.analysis.forEach((fileData, fileIdx) => {
                // --- عنوان فرعي لكل صورة ---
                const fileTitle = document.createElement('h3');
                fileTitle.innerText = `Image ${fileIdx + 1}: ${fileData.file_name || `Unnamed`}`;
                fileTitle.className = "text-xl font-semibold text-gray-800 mb-4 mt-4";
                frame2Card.appendChild(fileTitle);

                // --- General Preprocessing ---
const stepsWrapper = document.createElement('div');
stepsWrapper.className = "flex flex-wrap gap-4 mb-4";

fileData.image_sections?.filter(sec => sec.section_type === 'general')?.forEach(sec => {
    if(sec.image){
        const stepDiv = document.createElement('div');
        stepDiv.className = "text-center bg-gray-50 rounded-lg shadow p-3";

        const img = document.createElement('img');
        img.src = sec.image;
        img.alt = sec.title;
        img.className = "rounded-lg mb-2 shadow-sm";
        img.style.width='130px';
        img.style.height='130px';
        img.style.objectFit='contain';

        const caption = document.createElement('div');
        let displayTitle = sec.title;
        if(displayTitle === "Enhanced") displayTitle = "Image Enhancement";
        if(displayTitle === "YOLO Annotated") displayTitle = "Joints Detected";
        caption.innerText = displayTitle;
        caption.className = "text-sm text-gray-600";

        stepDiv.appendChild(img);
        stepDiv.appendChild(caption);
        stepsWrapper.appendChild(stepDiv);
    }
});
frame2Card.appendChild(stepsWrapper);


                // --- Knee Sections ---
                fileData.image_sections?.filter(sec=>sec.section_type==='knee')?.forEach(knee=>{
                    const kneeTitle = document.createElement('h4');
                    kneeTitle.innerHTML = `<span class="font-bold text-lg text-gray-800">${knee.knee_position}</span> - Porosis Diagnosis`;
                    kneeTitle.className = "mt-6 mb-3";
                    frame2Card.appendChild(kneeTitle);

                    const wrapperDiv = document.createElement('div');
                    wrapperDiv.className = "flex flex-wrap gap-4";

                    const kneeImages = ['cropped','resized','gradcam'];
                    kneeImages.forEach(key=>{
                        if(knee.images[key]){
                            const stepDiv = document.createElement('div');
                            stepDiv.className = "text-center bg-gray-50 rounded-lg shadow p-3";

                            const img = document.createElement('img');
                            img.src = knee.images[key];
                            img.alt = key;
                            img.className = "rounded-lg mb-2 shadow-sm";
                            img.style.width='130px';
                            img.style.height='130px';
                            img.style.objectFit='contain';

                            const caption = document.createElement('div');
                            caption.innerText = key==='gradcam'?'Diagnostic Highlights':(key.charAt(0).toUpperCase()+key.slice(1));
                            caption.className = "text-sm text-gray-600";

                            stepDiv.appendChild(img);
                            stepDiv.appendChild(caption);
                            wrapperDiv.appendChild(stepDiv);
                        }
                    });

                    frame2Card.appendChild(wrapperDiv);

                    // --- Results ---
                    const resultsBox = document.createElement('div');
                    resultsBox.className = "mt-4 p-3 bg-blue-50 rounded-lg border shadow-sm";

                    const pred = knee.result[0];
                    const classProbs = pred.class_probabilities_percent;
                    const maxConf = Math.max(...Object.values(classProbs));

                    Object.entries(classProbs).forEach(([label,conf])=>{
                        const p = document.createElement('p');
                        if(conf===maxConf){
                            p.innerHTML = `✅ <b>${label}: ${conf}%</b>`;
                            p.className = "text-lg mb-1 text-blue-700 font-bold";
                        }else{
                            p.innerHTML = `${label}: ${conf}%`;
                            p.className = "text-sm text-gray-700";
                        }
                        resultsBox.appendChild(p);
                    });

                    frame2Card.appendChild(resultsBox);
                    frame2Labels.push(pred.label);
                });
            });

            messageContainer.appendChild(frame2Card);

        }
    } catch(err){
        console.warn("Frame 2 skipped due to error:", err);
    }
}


        // --- Frame 3 ---
        if (window.frame3Data && window.frame3Data.age) {
            try {
                const res3 = await fetch('/process_risk_factors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(window.frame3Data)
                });
                if (res3.ok) {
                    const data3 = await res3.json();
                    if (data3.result) {
                        const { label, confidence } = data3.result;
                        const labelText = mapLabel(label === 0 ? "Normal" : "Osteoporosis");
                        frame3Label = labelText;

                        const card = createCard("Frame 3: Risk Factors Results", "text-[#0083b0]");
                        const p = document.createElement('p');
                        p.className = "text-gray-700 text-lg";
                        p.innerHTML = `<b>Diagnosis:</b> ${labelText} (${confidence}%)`;
                        card.appendChild(p);
                        messageContainer.appendChild(card);
                    } else if (data3.error) {
                        const card = createCard("Frame 3: Risk Factors Results", "text-[#ff0000]");
                        const p = document.createElement('p');
                        p.className = "text-red-700 text-lg";
                        p.innerHTML = `<b>Error:</b> ${data3.error}`;
                        card.appendChild(p);
                        messageContainer.appendChild(card);
                    }
                }
            } catch(err){
                console.warn("Frame 3 skipped due to error:", err);
            }
        }

        // --- Weighted Ensemble / Final Diagnosis ---
        const weightedVotes = { Normal: 0, Osteopenia: 0, Osteoporosis: 0 };
        if (frame1Label) weightedVotes[frame1Label] += 0.5;
        if (Array.isArray(frame2Labels) && frame2Labels.length > 0) {
            const counts = { Normal: 0, Osteopenia: 0, Osteoporosis: 0 };
            frame2Labels.forEach(lbl => { if (counts[lbl] !== undefined) counts[lbl]++; });
            const total = Object.values(counts).reduce((a,b)=>a+b,0);
            if (total > 0) Object.keys(counts).forEach(k => { weightedVotes[k] += (counts[k]/total)*0.2; });
        }
        if (frame3Label) weightedVotes[frame3Label] += 0.3;

        if (Object.values(weightedVotes).some(v => v > 0)) {
            const maxVote = Math.max(...Object.values(weightedVotes));
            const finalLabels = Object.entries(weightedVotes)
                .filter(([_, v]) => v === maxVote)
                .map(([k, _]) => k);

            const card = createCard("Final Bone Health Assessment", "text-[#006400]");
            const p = document.createElement('p');
            p.className = "text-gray-700 text-lg";
            p.innerHTML = `Based on available frames and evaluations, the <b>final diagnosis</b> is: <b>${finalLabels.join(" OR ")}</b>.<br>
            This combines the results from available frames with weighted importance (BMD 50%, X-ray 20%, Risk Factors 30%).`;
            card.appendChild(p);
            messageContainer.appendChild(card);
        }

    } catch(err){
        console.error("Error sending frames:", err);
        alert("❌ Error sending frames.");
    } finally {
        spinner.style.display = 'none';
    }
}








</script>



</body>

</html>
